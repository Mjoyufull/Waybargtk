#!/usr/bin/env bash
# Build script for Waybargtk (Waybar fork)
# This version builds fmt as a shared library via CMake (BUILD_SHARED_LIBS=TRUE)
# and then builds Waybargtk with Meson, linking against the shared fmt.

set -e

# ---------- Build fmt (shared) ----------
# Assume fmt source is available in the subprojects directory (pkgit clones it there)
FMT_SRC="$(pwd)/subprojects/fmt"
if [ ! -d "$FMT_SRC" ]; then
    echo "[bldit] ERROR: fmt source not found at $FMT_SRC"
    exit 1
fi

FMT_BUILD="$(pwd)/fmt-build"
FMT_INSTALL="$(pwd)/fmt-install"
mkdir -p "$FMT_BUILD"
cd "$FMT_BUILD"

echo "[bldit] Configuring fmt (shared) with CMake..."
cmake "$FMT_SRC" \
    -DCMAKE_BUILD_TYPE=Release \
    -DBUILD_SHARED_LIBS=TRUE \
    -DCMAKE_INSTALL_PREFIX="$FMT_INSTALL"

echo "[bldit] Building and installing fmt..."
cmake --build . --config Release --target install

# Return to project root
cd "$(pwd)/../.."

# Add fmt's pkgconfig and library paths so Meson can find the shared library
export PKG_CONFIG_PATH="$FMT_INSTALL/lib/pkgconfig:${PKG_CONFIG_PATH}"
export LD_LIBRARY_PATH="$FMT_INSTALL/lib:${LD_LIBRARY_PATH}"

# ---------- Meson options (disable optional features) ----------
MESON_OPTS=(
    -Dlibinput=disabled
    -Dlibnl=disabled
    -Dlibudev=disabled
    -Dlibevdev=disabled
    -Dpulseaudio=disabled
    -Dupower_glib=disabled
    -Dpipewire=disabled
    -Dmpris=disabled
    -Dsystemd=disabled
    -Ddbusmenu-gtk=disabled
    -Dman-pages=disabled
    -Dmpd=disabled
    -Drfkill=disabled
    -Dsndio=disabled
    -Dlogind=disabled
    -Dtests=disabled
    -Djack=disabled
    -Dwireplumber=disabled
    -Dcava=disabled
    -Dgps=disabled
)

# ---------- Configure and build Waybargtk ----------
if [ -d "build" ]; then
    meson setup --reconfigure "${MESON_OPTS[@]}" build || { echo "[bldit] meson configuration failed"; exit 1; }
else
    meson setup "${MESON_OPTS[@]}" build || { echo "[bldit] meson configuration failed"; exit 1; }
fi

echo "[bldit] Building Waybargtk with ninja..."
ninja -C build || { echo "[bldit] build failed"; exit 1; }

# ---------- Install binary ----------
if [ -f "build/waybar" ]; then
    cp "build/waybar" "waybargtk"
    chmod +x waybargtk
    echo "[bldit] Build succeeded â€“ binary is ./waybargtk"
else
    echo "[bldit] ERROR: build/waybar not found after build"
    ls -la build/ || true
    exit 1
fi
