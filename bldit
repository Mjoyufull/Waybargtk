#!/usr/bin/env bash
# Simple build script for Waybargtk (Waybar fork)
# This script builds Waybargtk using Meson/Ninja with all optional features disabled.
# If you need a custom bldit for fmt, create /etc/pkgit/bldit/fmt with the following content:
#
# bldit () {
#     mkdir -p build
#     cd build
#     cmake -DBUILD_SHARED_LIBS=TRUE ..
#     make
# }
#
# -------------------------------------------------
# Meson options (disable optional features to avoid missing deps)
MESON_OPTS=(
    -Dlibinput=disabled
    -Dlibnl=disabled
    -Dlibudev=disabled
    -Dlibevdev=disabled
    -Dpulseaudio=disabled
    -Dupower_glib=disabled
    -Dpipewire=disabled
    -Dmpris=disabled
    -Dsystemd=disabled
    -Ddbusmenu-gtk=disabled
    -Dman-pages=disabled
    -Dmpd=disabled
    -Drfkill=disabled
    -Dsndio=disabled
    -Dlogind=disabled
    -Dtests=disabled
    -Djack=disabled
    -Dwireplumber=disabled
    -Dcava=disabled
    -Dgps=disabled
)

# Configure (reconfigure if build dir exists)
if [ -d "build" ]; then
    meson setup --reconfigure "${MESON_OPTS[@]}" build || { echo "[bldit] meson configuration failed"; exit 1; }
else
    meson setup "${MESON_OPTS[@]}" build || { echo "[bldit] meson configuration failed"; exit 1; }
fi

# Build using ninja
ninja -C build || { echo "[bldit] build failed"; exit 1; }

# Install binary
if [ -f "build/waybar" ]; then
    cp "build/waybar" "waybargtk"
    chmod +x waybargtk
    echo "[bldit] Build succeeded â€“ binary is ./waybargtk"
else
    echo "[bldit] ERROR: build/waybar not found after build"
    ls -la build/ || true
    exit 1
fi
